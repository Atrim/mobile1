<!doctype html>
<!--[if IEMobile 7 ]><html class="no-js iem7 standalone"><![endif]-->
<!--[if (gt IEMobile 7)|!(IEMobile)]><!--> <html class="no-js "><!--<![endif]-->
  <head>
    <title>StarTrackr</title>
    
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    
    <!-- For iPad -->
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../apple-touch-icon-72x72-precomposed.png">
    <!-- For iPhone 4 with high-resolution Retina display -->
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../apple-touch-icon-114x114-precomposed.png">
    <!-- For iOS 1- and Blackberry 6 -->
    <link rel="apple-touch-icon" href="../apple-touch-icon.png">
    <!-- For pre-retina iPhone, iPod Touch, and Android 2.1+ devices -->
    <link rel="apple-touch-icon-precomposed" href="../apple-touch-icon-precomposed.png">
    <!-- Startup image -->
    <link rel="apple-touch-startup-image" href="../apple-touch-startup-image.png">
    
    <link type="text/css" rel="stylesheet" href="../stylesheets/screen.css" media="screen"/>
    <link type="text/css" rel="stylesheet" href="../stylesheets/transitions.css" media="screen"/>
    
    <!--
      Mapping stuff is way down the bottom. Look for comment: FOR MAPS
        

    -->
    
    
    <style type="text/css" media="screen">
    #pages {
      position: relative;
    }
    #pages > div {
      display: none;
      position: absolute;
      left: 0;
      width: 100%;
    }
    
    #pages > div.current {
      display: block;
    }
    
    /* FOR MAP */
    #geo-map {
      width: 100%;
      height: 300px;
    }
    #geo-container {
      display: none;
    }
    
    #geo-container, #show-geo-container {
      background-color: #EDC82B;
      min-height: 50px;
    }
    #geo-container > span, #show-geo-container > span {
      background-color: #800;
      padding:10px;
      color :#fff;
      border: 1px solid #000;
    }
    </style>
  </head>
  <body>
    <ul id="tab-bar" class="page-spots">
      <li id="tab-spots">
        <a href="#page-spots">
          Spots
        </a>
      </li>      
      <li id="tab-sighting">
        <a href="#page-sightings">
          Add a sighting
        </a>
      </li>
      <li id="tab-stars">
        <a href="#page-stars">
          Stars
        </a>
      </li>
    </ul><!-- #tab-bar -->
  
  <div id="pages">
    <!-- Spots page -->
    <div id="page-spots" class="page-spots">
      <div class="header">
        <h1>Spots</h1>
        <a href="#" class="back">Back</a>
      </div><!-- .header -->
    
      <div class="wrapper">
        <div class="scroller" id="spots-scroll">
          <form id="spots-location" action="/location/" method="post">
            <fieldset>
              <label for="address">
                <span>Location</span>
                <input type="text" placeholder="Enter a location" name="address" id="address"/>
              </label>
              <a href="#" class="locate-me">Locate me</a>
            </fieldset>
            <button type="submit">Find</button>
          </form><!-- #spot-location -->
        
          <ul id="spots-list" class="table-view table-action">
          </ul><!-- #spots-list -->

        </div><!-- .scroller -->
        <div class="footer">
          <span class="site-switch">
            Switch to
            <a href="#">standard site</a>
          </span>
          <a href="#" class="authenticate">Log out</a>
        </div><!-- .footer -->
      </div><!-- .wrapper -->
    </div><!-- #pages -->
    
    
    <!-- Spot page -->
    <div id="page-spot" class="page-spots">
      <div class="header">
        <h1>Spots</h1>
        <a href="#" class="back">Back</a>
      </div><!-- .header -->

      <div class="wrapper">
        <div class="scroller">
          <div class="page-header">
            <h1>Planet Hollywood</h1>
            <span class="address">123 Fake St, Hollywood, CA</span>
            <a href="#" class="map">
              <img src="http://maps.google.com/maps/api/staticmap?zoom=14&size=65x60&maptype=roadmap&markers=size:mid%7Ccolor:red%7Chollywood+blvd+la&sensor=false"/>
            </a>
          </div>
          <ul id="sightings-list" class="table-view table-list">
            <li>
              <a class="avatar" href="#">
                <img src="../images/sightings/garrett.jpg" alt="">
              </a>
              <h2><a href="star.html">Garrett Murray</a></h2>
              <span class="details">
                <strong class="time-ago">2 hours ago</strong>
                by
                <a href="#" class="user">makenosound</a>
              </span>
            </li>
            <li class="even">
              <a class="avatar" href="#">
                <img src="../images/sightings/garrett.jpg" alt="">
              </a>
              <h2><a href="star.html">Stuart Butterfield is a long long name</a></h2>
              <span class="details">
                <strong class="time-ago">2 hours ago</strong>
                by
                <a href="#" class="user">makenosound</a>
              </span>
            </li>
            <li>
              <a class="avatar" href="#">
                <img src="../images/sightings/garrett.jpg" alt="">
              </a>
              <h2><a href="star.html">Garrett Murray</a></h2>
              <span class="details">
                <strong class="time-ago">2 hours ago</strong>
                by
                <a href="#" class="user">makenosound</a>
              </span>
            </li>
            <li class="even">
              <a class="avatar" href="#">
                <img src="../images/sightings/garrett.jpg" alt="">
              </a>
              <h2><a href="star.html">Garrett Murray</a></h2>
              <span class="details">
                <strong class="time-ago">2 hours ago</strong>
                by
                <a href="#" class="user">makenosound</a>
              </span>
            </li>
          </ul><!-- #spots-list -->
          <a href="#" id="next-page">
            Next page
          </a>
        </div><!-- .scroller -->
        <div class="footer">
          <span class="site-switch">
            Switch to
            <a href="#">standard site</a>
          </span>
          <a href="#" class="authenticate">Log out</a>
        </div><!-- .footer -->
      </div><!-- .wrapper -->  
    </div><!-- #content -->

    <div id="page-sightings" class="page-sightings">
      <div class="header">
        <h1>New sighting</h1>
        <a href="#" class="back">Back</a>
      </div><!-- .header -->

      <div class="wrapper">
        <div class="scroller">
          <form action="" method="post">
            <fieldset>
              <label for="input-name" id="label-name">
                <span>Who</span>
                <input type="text" name="name" id="input-name" placeholder="Enter a name"/>
              </label>
              <label for="input-spot" id="label-spot">
                <span>Where</span>
                <input type="text" name="spot" id="input-spot" placeholder="Enter a spot or address"/>
                <a href="#" class="locate-me">Locate me</a>
              </label>
            </fieldset>
            <fieldset id="photo">
              <a href="#">Attach a photograph</a>
            </fieldset>


            
            <!-- FOR MAPS -->
            <fieldset id="show-geo-container">
              <span id="show-geo">Geo Track celeb</span>
            </fieldset>
            <fieldset id="geo-container">
              <span id="geo-start">Start Tracking</span>
              <span id="geo-stop">Stop Tracking</span>
              <div id="geo-map"></div>
            </fieldset>



            <fieldset id="share">
            </fieldset>
            <fieldset id="save">
              <button type="submit">Share your sighting</button>
            </fieldset>
          </form>
        </div><!-- .scroller -->
        <div class="footer">
          <span class="site-switch">
            Switch to
            <a href="#">standard site</a>
          </span>
          <a href="#" class="authenticate">Log out</a>
        </div><!-- .footer -->
      </div><!-- .wrapper -->  
    </div><!-- #content -->

    <!-- Stars page -->
    <div id="page-stars" class="page-stars">
      <div class="header">
        <h1>Stars</h1>
        <a href="#" class="back">Back</a>
      </div><!-- .header -->

      <div class="wrapper">
        <div class="scroller">
          <ul id="sightings-list" class="table-view table-action">
            <!--<li>
              <a href="star.html">
                <h2>I am a celebrity with an incredibly long name for some unfathomable reason</h2>
                <span class="sightings">5</span>
              </a>
            </li> -->
            <li>
              <a href="star.html">
                <h2>Caterina Fake</h2>
                <span class="sightings">5</span>
              </a>
            </li>
            <li>
              <a href="star.html">
                <h2>Dan Cederholm</h2>
                <span class="sightings">5</span>
              </a>
            </li>
            <li>
              <a href="star.html">
                <h2>Eric Meyer</h2>
                <span class="sightings">5</span>
              </a>
            </li>
            <li>
              <a href="star.html">
                <h2>Garrett Murray</h2>
                <span class="sightings">5</span>
              </a>
            </li>
            <li>
              <a href="star.html">
                <h2>Jeffrey Zeldman</h2>
                <span class="sightings">5</span>
              </a>
            </li>
            <li>
              <a href="star.html">
                <h2>Sophia Teutschler</h2>
                <span class="sightings">5</span>
              </a>
            </li>
            <li>
              <a href="star.html">
                <h2>Tina Roth Eisenberg</h2>
                <span class="sightings">5</span>
              </a>
            </li>
            <li>
              <a href="star.html">
                <h2>Veerle Pieters</h2>
                <span class="sightings">5</span>
              </a>
            </li>
          </ul><!-- #spots-list -->
          <a href="#" id="next-page">
            Next page
          </a>
        </div><!-- .scroller -->
        <div class="footer">
          <span class="site-switch">
            Switch to
            <a href="#">standard site</a>
          </span>
          <a href="#" class="authenticate">Log out</a>
        </div><!-- .footer -->
      </div><!-- .wrapper -->  
    </div><!-- #content -->

    <!-- Star page -->
    <div id="page-star" class="page-stars">
      <div class="header">
        <h1>Stars</h1>
        <a href="#" class="back">Back</a>
      </div><!-- .header -->
    
      <div class="wrapper">
        <div class="scroller">
          <div class="page-header">
            <h1>Garrett Murray</h1>
            <span class="sightings">13 sightings</span>
            <a href="#" class="map">
              <img src="../images/stars/garrett.jpg"/>
            </a>
          </div>
          <ul id="star-spots-list" class="table-view table-list">
            <li>
              <a class="avatar" href="#">
                <img src="../images/sightings/garrett.jpg" alt="">
              </a>
              <h2><a href="spot.html">Planet Hollywood</a></h2>
              <span class="details">
                <strong class="time-ago">2 hours ago</strong>
                by
                <a href="#" class="user">makenosound</a>
              </span>
            </li>
          </ul><!-- #spots-list -->
          <a href="#" id="next-page">
            Next page
          </a>
        </div><!-- .scroller -->
        <div class="footer">
          <span class="site-switch">
            Switch to
            <a href="#">standard site</a>
          </span>
          <a href="#" class="authenticate">Log out</a>
        </div><!-- .footer -->
      </div><!-- .wrapper -->  
    </div><!-- #pages -->
        
  </div>

  <!-- For jQ tmpl 2 -->
  <script id="tmpl-tweet" type="text/x-jquery-tmpl">
  	<li>
      <a href="spot.html">
        <h2>${name}</h2>
        <span class="relative-distance">${location.distance}m away</span>
        <span class="sightings">${hereNow.count}</span>
      </a>
    </li>
  </script>

    <script type="text/javascript" src="../javascripts/vendor/modernizr-1.7.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js"></script>
    <script type="text/javascript" src="../javascripts/vendor/jquery.tmpl.min.js" ></script>
    <script src="../javascripts/vendor/helper.js"></script>
    <script src="../javascripts/vendor/iscroll-min.js" type="text/javascript" charset="utf-8"></script>
    
    <!-- FOR MAPS -->
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>

    <script type="text/javascript" charset="utf-8">
      $(document).ready(function() {

        // Ex 03-02a - fade with function
        $("#tab-bar a").click(function(e){
          e.preventDefault();
          var nextPage = $(e.target.hash);
        
          // Clear visit history
          visits.clear();
          
          // Set the current icon
          $("#tab-bar").attr("className", e.target.hash.slice(1))

          transition(nextPage, "show");
        });
        
        
        fetchGeo();
        transition($("#page-spots"), "show");
        
        // Set the tab bar position
        setTabBarPosition();
      });
      
      // Ex 03-03a - list...
      $("#spots-list li").live("click", function(e){
        e.preventDefault();
        transition("#page-spot", "push");

      });
      $("#sightings-list li").click(function(e){
        e.preventDefault();
        transition("#page-star", "push");
      });
      $("#star-spots-list li").click(function(e){
        e.preventDefault();
        transition("#page-spot", "push");
      });
      
      var visits = {
        history: [],
        hasBack: function() {
          return this.history.length > 1;
        },
        add: function(page) {
          this.history.push(page);
        },
        back: function() {
          if(!this.hasBack()){
            return;
          }
          var curPage = this.history.pop();
          return this.history.pop();
        },
        clear: function() {
            return;
          this.history = [];
        }
      };
      
      // Handle back clicks
      $(".back").live("click",function(){
          var lastPage = visits.back();
          if(lastPage) {
              transition(lastPage, "push", true);
          }
      });
      
      // Ex 03-03a - transition with reverse
      function transition(toPage, type, reverse){
        var toPage = $(toPage),
          fromPage = $("#pages .current"),
          reverse = reverse ? "reverse" : "";
        
        visits.add(toPage);
        toPage.find(".back").toggle(visits.hasBack());

        if(toPage.hasClass("current") || toPage === fromPage) { 
          return; 
        };

        setTabBarPosition();

        // For non-animatey browsers
        if(!("WebKitTransitionEvent" in window)){
            toPage.addClass("current");
            fromPage.removeClass("current");
            return;
        }
        
        toPage
          .addClass("current " + type + " in " + reverse)
          .one("webkitAnimationEnd", function(){
            fromPage.removeClass("current " + type + " out " + reverse);
            toPage.removeClass(type + " in " + reverse);
          });
        fromPage.addClass(type + " out " + reverse);


      }
      
      // Move the tab bar
      var setTabBarPosition = function() {
        if(navigator.standalone) {
          document.getElementById('tab-bar').style.top = (window.pageYOffset + window.innerHeight - 65) + 'px';
        }
      }

      // Bind setTabBarPosition to scoll event
      window.onscroll = function() {
        setTabBarPosition();
      }
      
      /*
            GEO LOCATION STUFF
      */
      
      $(".locate-me").click(function(){
        fetchGeo();
      });
      
      function fetchGeo() {

        navigator.geolocation.getCurrentPosition(
          function(pos) {
            // Succesfully got location
            var lat = pos.coords.latitude,
                lng = pos.coords.longitude;
            fetchLocations(lat, lng);
            
          },
          function(error) {
            // Failed to get location
            alert("Error fetching geolocation.");
          }, {
            // Options for geolocation
            maximumAge: 10000, 
            timeout: 10000,
            enableHighAccuracy: true
          }
        );
      }
      
      function fetchLocations(lat, lng) {
        var keywords = $("#address").val(),
            location = "&ll=" + lat + "," + lng,
            query = keywords ? "&query=" + keywords : "",
            secrets = "&client_id=JTHNTGXROWPZVZ1MNNWJ411PIPDAOO3I4VTKC4TNXNDVALJ3&client_secret=WMX25UJBHEZMGDXKVZR2TTC3CKA2W3E4JC4HMVVZ3W321A4Q";

        $.ajax({
          url: "https://api.foursquare.com/v2/venues/search?" + location + query + secrets + "&callback=",
          type: "GET",
          dataType: "JSON",
          success: function(data){
            displayLocations(data.response.groups);
          },
          error: function(){
            alert("Error fetching locations.");
            console.log(arguments);
          }
        })
      }
      
      function displayLocations(groups) {

        $("#spots-list").children().remove();

        for(var i = 0; i < groups.length; i++) {
          if(groups[i].type === 'places' || groups[i].type === 'nearby') {
            $("#tmpl-tweet")
              .tmpl(groups[i].items)
              .appendTo("#spots-list");
          }
        }
      }
      
      /* Mapping tracking */
      
      $(document).ready(function(){
        $("#show-geo").click(function(){
          $("#geo-container, #show-geo-container").toggle("fast");
          initGeoTracking();
        });
        
        $("#geo-start").click(function(){
          alert("Tracking celebrity.\nHappy hunting!");
          startTracking();
        });
        
        $("#geo-stop").click(function(){
          navigator.geolocation.clearWatch(watchId);
          alert("Thank you for your hard work.\n" + allPositions.length + " data points collected!");
          $.post("geo-post", { 'positions': allPositions })
        });
      });

      var map,
          watchId;
          lastPos = {},
          allPositions = [];

      function initGeoTracking() {
         var mapElement = $("#geo-map")[0],
            mapOptions = {
              zoom: 12,
              streetViewControl: false,
              center: new google.maps.LatLng(-37.8071, 144.9853),
              mapTypeId: google.maps.MapTypeId.ROADMAP
            };
          map = new google.maps.Map(mapElement, mapOptions);
      };
      
      function startTracking() {
        lastPos = {};
        allPositions = [];
        watchId = navigator.geolocation.watchPosition(
          function(pos) {
            var newPos = {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude
            };
            if(newPos.lat === lastPos.lat && newPos.lng === lastPos.lng){
              return;
            }
            allPositions.push(newPos);
            lastPos = newPos;
            $.post("/geo-post.php", {
                lat: newPos.lat,
                lng: newPos.lng
            });
            
            // Succesfully got location
            var posLatLng = new google.maps.LatLng(
                newPos.lat, 
                newPos.lng);

            var marker = new google.maps.Marker({
              position: posLatLng, 
              map: map,
              draggable:true,
              animation: google.maps.Animation.DROP
            });

            map.setCenter(posLatLng);

          },
          function(error) {
            // Failed to get location
            var msg = "Error.";
            switch(error.code) {
              case error.PERMISSION_DENIED:
                msg = "Ooops. You have disallowed our app!";
                break;
              case error.POSITION_UNAVAILABLE:
                msg = "Sorry, we couldn't get your location.";
                break;
              case error.TIMEOUT:
                msg = "Sorry, fetch timeout expired.";
                break;
            }
            alert(msg);
          }
        );
      }

    </script>
  </body>
</html>
